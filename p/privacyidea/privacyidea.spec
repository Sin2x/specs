%define oname privacyIDEA
%define server_group privacyidea
%define server_user privacyidea

# disable due broken dateutil due new tzdata
# https://bugzilla.altlinux.org/show_bug.cgi?id=39164
%def_without test

Name: privacyidea
Version: 3.4.1
Release: alt1

Summary: Identity, multifactor authentication (OTP), authorization, audit

License: AGPL-3.0
Group: System/Servers
Url: https://www.privacyidea.org/

# Source-url: %__pypi_url %oname
Packager: Vitaly Lipatov <lav@altlinux.ru>

Source: %name-%version.tar

BuildArch: noarch

#AutoProv: no

BuildRequires(pre): rpm-build-python3
BuildRequires(pre): rpm-build-intro >= 2.2.4
BuildRequires: python3-module-setuptools

Requires: python3 > 3.4

# for test
%if_with test
# generated by epm --restore --dry-run from tests/requirements.txt
%py3_use attrs >= 19.3.0
%py3_use coverage >= 5.1
%py3_use importlib-metadata >= 1.6.0
%py3_use mock >= 4.0.2
%py3_use mock >= 3.0.5
%py3_use more-itertools >= 8.2.0
%py3_use packaging >= 20.3
%py3_use pluggy >= 0.13.1
%py3_use py >= 1.8.1
%py3_use pyparsing >= 2.4.7
%py3_use pytest >= 5.4.1
%py3_use pytest-cov >= 2.8.1
%py3_use pytest-subtests >= 0.3.1
%py3_use responses >= 0.10.12
%py3_use testfixtures >= 6.14.0
%py3_use wcwidth >= 0.1.9
%py3_use zipp >= 3.1.0
%py3_use zipp >= 1.2.0
%endif

# generated by epm --restore --dry-run from privacyidea/requirements.txt
%py3_use alembic >= 1.4.2
%py3_use argon2-cffi >= 20.1.0
%py3_use babel >= 2.8.0
%py3_use bcrypt >= 3.1.7
%py3_use BeautifulSoup4 >= 4.9.0
%py3_use cbor2 >= 5.1.0
%py3_use certifi >= 2020.4.5.1
%py3_use cffi >= 1.14.0
%py3_use chardet >= 3.0.4
%py3_use click >= 7.1.1
%py3_use configobj >= 5.0.6
%py3_use croniter >= 0.3.31
%py3_use cryptography >= 2.9
%py3_use defusedxml >= 0.6.0
%py3_use ecdsa >= 0.15
%py3_use flask >= 1.1.2
%py3_use flask-babel >= 1.0.0
%py3_use flask-migrate >= 2.5.3
%py3_use flask-script >= 2.0.6
%py3_use flask-sqlalchemy >= 2.4.1
%py3_use flask-versioned >= 0.9.4
%py3_use httplib2 >= 0.18.0
%py3_use huey >= 2.2.0
%py3_use idna >= 2.9
%py3_use itsdangerous >= 1.1.0
%py3_use jinja2 >= 2.11.2
%py3_use ldap3 >= 2.6.1
%py3_use lxml >= 4.5.0
%py3_use mako >= 1.1.2
%py3_use markupsafe >= 1.1.1
%py3_use netaddr >= 0.7.19
%py3_use oauth2client >= 4.1.3
%py3_use passlib >= 1.7.2
%py3_use Pillow >= 7.1.1
%py3_use pyasn1 >= 0.4.8
%py3_use pyasn1-modules >= 0.2.8
%py3_use pycparser >= 2.20
%py3_use jwt >= 1.7.1
%py3_use pymysql >= 0.9.3
%py3_use OpenSSL >= 19.1.0
%py3_use pyrad >= 2.3
%py3_use dateutil >= 2.8.1
%py3_use editor >= 1.0.4
%py3_use gnupg >= 0.4.5
%py3_use pytz >= 2019.3
%py3_use yaml >= 5.3.1
%py3_use qrcode >= 6.1
%py3_use redis-py >= 3.4.1
%py3_use requests >= 2.23.0
%py3_use rsa >= 4.1
%py3_use six >= 1.14.0
%py3_use smpplib >= 2.1.0
%py3_use soupsieve >= 2.0
%py3_use SQLAlchemy >= 1.3.16
%py3_use sqlsoup >= 0.9.1
%py3_use urllib3 >= 1.25.8
# blocked due old Obdoo
%py3_use werkzeug
#py3_use werkzeug >= 1.0.1
%py3_use pydash >= 4.7.4

%add_python3_lib_path %_datadir/%name

%description
privacyIDEA: identity, multifactor authentication, authorization.
privacyIDEA is an open solution for strong two-factor authentication.
privacyIDEA aims to not bind you to any decision of the authentication protocol
or it does not dictate you where your user information should be stored.
This is achieved by its totally modular architecture.
privacyIDEA is not only open as far as its modular architecture is concerned.
But privacyIDEA is completely licensed under the AGPLv3.

%prep
%setup

%build
%python3_build

%install
%python3_install
%python3_prune

install -dm 0755 %buildroot%_logdir/privacyidea
# Move files into "right" locations...
install -dm 0755 %buildroot%_sysconfdir/privacyidea
install -dm 0755 %buildroot%_datadir/privacyidea
mv  %buildroot%prefix/etc/privacyidea/* %buildroot%_sysconfdir/privacyidea
mv  %buildroot/usr/lib/privacyidea/* %buildroot%_datadir/privacyidea/
# "cleanup"
rm -rf %buildroot%_datadir/privacyidea/authmodules/
rm -rf %buildroot%prefix/etc
rm -rf %buildroot%_libdir/privacyidea

mkdir -p %buildroot%_sysconfdir/privacyidea/gpg/
touch %buildroot%_sysconfdir/privacyidea/{data.sqlite,enckey,pi.cfg,usersdb.install,users.sqlite}

# set python3
subst "s|/usr/bin/env python$|/usr/bin/python3|" %buildroot%_bindir/*

# python2 code
rm -fv %buildroot%python3_sitelibdir/%oname-*.egg-info/jwttest.py

# move to docs
rm -rfv %buildroot%python3_sitelibdir/authmodules/

%if_with test
%check
%python3_test
%endif

# TODO:
%post
%_bindir/getent group %server_group >/dev/null || %_sbindir/groupadd -r %server_group
%_bindir/getent passwd %server_user >/dev/null || %_sbindir/useradd -r \
    -d %_sharedstatedir/%server_user \
    -s /bin/false -c "privacyIDEA sevice user" -g %server_group %server_user

%files
%python3_sitelibdir/privacyidea/
%python3_sitelibdir/%oname-*.egg-info
%dir %_sysconfdir/privacyidea
%config %_sysconfdir/privacyidea/dictionary
#%config %_sysconfdir/privacyidea/privacyideaapp.wsgi
%ghost %config %_sysconfdir/privacyidea/data.sqlite
%ghost %config %_sysconfdir/privacyidea/enckey
%ghost %config %_sysconfdir/privacyidea/pi.cfg
%ghost %config %_sysconfdir/privacyidea/usersdb.install
%ghost %config %_sysconfdir/privacyidea/users.sqlite
%dir %_sysconfdir/privacyidea/gpg
%dir %_datadir/privacyidea
%dir %_datadir/privacyidea/migrations
%dir %_datadir/privacyidea/migrations/versions
%dir %_logdir/privacyidea
%_bindir/creategoogleauthenticator-file
%_bindir/getgooglecodes
%_bindir/pi-manage
#%_bindir/privacyidea-decrypt-safeword.py
%_bindir/privacyidea-sync-owncloud.py
%_bindir/privacyidea-update-linotp-counter.py
%_bindir/privacyidea-user-action
%_bindir/privacyidea-convert-base32.py
%_bindir/privacyidea-convert-token
%_bindir/privacyidea-convert-xml-to-csv
%_bindir/privacyidea-create-ad-users
%_bindir/privacyidea-create-certificate
%_bindir/privacyidea-create-pwidresolver-user
%_bindir/privacyidea-create-sqlidresolver-user
%_bindir/privacyidea-create-userdb
%_bindir/privacyidea-cron
%_bindir/privacyidea-diag
%_bindir/privacyidea-expired-users
%_bindir/privacyidea-export-linotp-counter.py
%_bindir/privacyidea-export-privacyidea-counter.py
%_bindir/privacyidea-fetchssh
# unknown module oath
#_bindir/privacyidea-find-oath
%_bindir/privacyidea-fix-access-rights
%_bindir/privacyidea-get-serial
%_bindir/privacyidea-get-unused-tokens
%_bindir/privacyidea-migrate-linotp.py
%_bindir/privacyidea-pip-update
%_bindir/privacyidea-queue-huey
%_bindir/privacyidea-schema-upgrade
%_bindir/privacyidea-standalone
%_bindir/privacyidea-token-janitor
%_bindir/privacyidea-update-counter.py
%_bindir/privacyidea-usercache-cleanup
%_bindir/reset-privacyidea
# python2 only
#_bindir/linotp-decrypt-otpkey
%_bindir/test-linotp.py
%_datadir/privacyidea/migrations/versions/*.py
%_datadir/privacyidea/migrations/script.py.mako
%_datadir/privacyidea/migrations/env.py
%_datadir/privacyidea/migrations/README
%_datadir/privacyidea/migrations/alembic.ini
%_datadir/privacyidea/requirements.txt
%_man1dir/privacyidea-convert-token.1*
%_man1dir/privacyidea-create-ad-users.1*
%_man1dir/privacyidea-create-certificate.1*
%_man1dir/privacyidea-create-pwidresolver-user.1*
%_man1dir/privacyidea-create-sqlidresolver-user.1*
%_man1dir/privacyidea-create-userdb.1*
%_man1dir/privacyidea-fetchssh.1*
%_man1dir/privacyidea-fix-access-rights.1*
%_man1dir/privacyidea-pip-update.1*

%changelog
* Tue Nov 03 2020 Vitaly Lipatov <lav@altlinux.ru> 3.4.1-alt1
- new version 3.4.1 (with rpmrb script)
- update requires

* Thu Apr 09 2020 Eugene Omelyanovich <regatio@etersoft.ru> 3.3-alt1
- new version

